{%- comment -%}
This include creates the following variables:

is_top_page:        true if current page is top page

has_children:       true if current page is a top page that has children

top_pages:          array with all top-level page objects, ordered by nav_order
                    e.g. [Introduction, Development, ...]

top_child_pages:    array of array of pages, first array has same index as top pages,
                    inner array contains direct children sorted by nav_order
                    e.g. [[], [Dev1, Dev2], ...]

next_page:          next page in nav order

previous_page:      previous page in nav order (or parent, if it is the first page)

{%- endcomment -%}


{% if page != nil %}

{%- comment -%}
=== top_pages ===
{%- endcomment -%}

{% assign top_pages = site.pages
  | where_exp: "item", "item.title != nil"
  | where_exp: "item", "item.parent == nil"
| sort: "nav_order"
%}


{%- comment -%}
=== is_top_page ===
{%- endcomment -%}

{% assign int_first_filtered = top_pages | where_exp: "item", "item.title == page.title" | first %}
{% if int_first_filtered %}
{% assign is_top_page = 1 %}
{% else %}
{% assign is_top_page = 0 %}
{% endif %}

{%- comment -%}
=== top_child_pages ===
{%- endcomment -%}

{% assign top_child_pages = "" | split: "," %}

{% for top_page in top_pages %}
    {% assign int_curr_children = site.pages
      | where_exp: "item", "item.title != nil"
      | where_exp: "item", "item.parent == top_page.title"
    | sort: "nav_order" %}

    {% assign top_child_pages = top_child_pages | push: int_curr_children %}
{% endfor %}


{%- comment -%}
=== has children ===
{%- endcomment -%}

{% if is_top_page == 1 %}
    {% assign int_children_of_this_page = site.pages
      | where_exp: "item", "item.title != nil"
      | where_exp: "item", "item.parent == page.title"
        | sort: "nav_order" %}
    {% assign first_child = int_children_of_this_page | first %}
{% endif %}


{%- comment -%}
=== next_page / last_page ===
{%- endcomment -%}

{% if is_top_page == 1%}


    {%comment%} +++ read index of current page from top_pages array +++ {%endcomment%}

    {% capture int_my_idx_str -%}
    {% include find_idx_by_title pages=top_pages title=page.title %}
    {%- endcapture %}

    {% if int_my_idx_str != "" # only convert if not empty string %}
    {% assign int_my_idx = int_my_idx_str | plus: 0%}
    {% endif %}


    {%comment%} +++ determine next page in navigation +++ {%endcomment%}
    
    {% assign int_next_top_page = top_pages | where_exp: "item", "item.nav_order > page.nav_order" | first %}

    {% assign int_my_children = top_child_pages[int_my_idx] %}
    {% assign int_my_first_child = int_my_children | first %}

    {% if int_my_first_child != nil %}
        {% assign int_next_child_or_top_page = int_my_first_child %}
    {% else %}
        {% assign int_next_child_or_top_page = int_next_top_page %}
    {% endif %}

    {%comment%}
        set to int_next_top_page so top pages always link to next top page, 
        or int_next_child_or_top_page to link to the next child of the this
        top page, if possible
    {%endcomment%}
    {% assign next_page = int_next_child_or_top_page %}
    

    {%comment%} +++ determine previous page in navigation +++{%endcomment%}
    {% assign int_previous_top_page = top_pages | where_exp: "item", "page.nav_order > item.nav_order" | last %}
    {% assign int_parent_predecessor = int_my_idx|minus:1 %}

    {% if int_parent_predecessor >= 0 %}
        {% assign int_parent_predecessor_children = top_child_pages[int_parent_predecessor] %}
        {% assign int_num_parent_predecessor_children = int_parent_predecessor_children | size %}

        {% if int_num_parent_predecessor_children == 0 %}
            {% assign int_previous_child_or_top_page = top_pages[int_parent_predecessor] %}
        {% else %}
            {% assign int_previous_child_or_top_page = int_parent_predecessor_children[-1] %}
        {% endif %}
    {% endif %}

    {%comment%}
        set to int_pervious_top_page so top pages always link to previous top page, 
        or int_previous_child_or_top_page to link to the last child of the previous
        top page, if possible
    {%endcomment%}
    {% assign previous_page = int_previous_child_or_top_page %}
{% else %}

    {% capture int_parent_idx_str -%}
    {% include find_idx_by_title pages=top_pages title=page.parent %}
    {%- endcapture %}
    
    {% if int_parent_idx_str != "" # only convert if not empty string %}
    {% assign int_parent_idx = int_parent_idx_str | plus: 0%}
    {% endif %}

    {% if int_parent_idx %}
        {% assign int_siblings = top_child_pages[int_parent_idx] %}

        {% assign next_page     = int_siblings | where_exp: "item", "item.nav_order > page.nav_order" | first %}
        {% assign previous_page = int_siblings | where_exp: "item", "page.nav_order > item.nav_order" | last %}
    {% endif %}

    {% if previous_page == Nil && int_parent_idx %}
        {% assign previous_page = top_pages[int_parent_idx] %}
    {% endif %}
    
    {% if next_page == nil && int_parent_idx %}
        {% assign int_parent_successor = int_parent_idx|plus:1  %}
        {% assign next_page = top_pages[int_parent_successor] %}
    {% endif %}
{% endif %}

{% endif %}